<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel to PowerPoint Generator</title>

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

    <style>
        :root {
            --primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --primary-solid: #667eea;
            --success: #48bb78;
            --warning: #ed8936;
            --error: #f56565;
            --surface: rgba(255, 255, 255, 0.95);
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --border: rgba(0, 0, 0, 0.1);
            --shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            --radius: 16px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            padding: 2rem 1rem;
        }

        .container {
            max-width: 50rem;
            margin: 0 auto;
        }

        .card {
            background: var(--surface);
            backdrop-filter: blur(20px);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .header {
            background: var(--primary);
            padding: 2.5rem 2rem;
            text-align: center;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .header h1 {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            margin-top: 1rem;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 2px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .content {
            padding: 2.5rem 2rem;
        }

        .step {
            margin-bottom: 2.5rem;
        }

        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .step-number {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 1rem;
        }

        .step-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .file-input-wrapper {
            position: relative;
            border: 2px dashed var(--border);
            border-radius: 12px;
            background: linear-gradient(45deg, #f8fafc, #f1f5f9);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-input-wrapper:hover {
            border-color: var(--primary-solid);
            background: linear-gradient(45deg, #f0f8ff, #e6f3ff);
            transform: scale(1.02);
        }

        .file-input-wrapper.has-file {
            border-color: var(--success);
            background: linear-gradient(45deg, #f0fff4, #e6fffa);
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-content {
            padding: 2rem;
            text-align: center;
        }

        .file-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .file-text {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .file-subtext {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .file-name {
            margin-top: 1rem;
            padding: 0.75rem 1rem;
            background: rgba(72, 187, 120, 0.1);
            border-radius: 8px;
            color: var(--success);
            font-weight: 500;
            font-size: 0.875rem;
        }

        .button-group {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .btn {
            flex: 1;
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: white;
            color: var(--text-primary);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover {
            background: #f7fafc;
            border-color: var(--primary-solid);
        }

        .btn-loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        .btn-loading .btn-text {
            opacity: 0;
        }

        @keyframes spin {
            0% {
                transform: translate(-50%, -50%) rotate(0deg);
            }

            100% {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }

        .status-panel {
            background: #f8fafc;
            border: 1px solid var(--border);
            border-radius: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 2rem;
        }

        .status-panel:empty {
            display: none;
        }

        .status-header {
            padding: 1rem 1.5rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
            border-bottom: 1px solid var(--border);
        }

        .status-content {
            padding: 1rem 1.5rem;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.8rem;
            line-height: 1.5;
        }

        .status-message {
            display: block;
            margin-bottom: 0.5rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .status-success {
            color: var(--success);
        }

        .status-warning {
            color: var(--warning);
        }

        .status-error {
            color: var(--error);
        }

        .status-info {
            color: var(--primary-solid);
        }

        .data-preview {
            background: #f8fafc;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .data-preview h4 {
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .data-item {
            display: flex;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .data-key {
            font-weight: 600;
            color: var(--primary-solid);
            min-width: 200px;
            margin-right: 1rem;
        }

        .data-value {
            color: var(--text-secondary);
            flex: 1;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid var(--border);
            margin-bottom: 2rem;
        }

        .tab {
            padding: 1rem 2rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .tab.active {
            border-bottom-color: var(--primary-solid);
            color: var(--primary-solid);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 640px) {
            .button-group {
                flex-direction: column;
            }

            .step-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .step-number {
                margin-right: 0;
                margin-bottom: 0.5rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="card">
            <div class="header">
                <h1>üìä‚û°Ô∏èüìã Excel to PowerPoint Generator</h1>
                <p>Extract data from Excel and generate PowerPoint presentations</p>
                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>

            <div class="content">
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('extract')">üìä Extract Data</div>
                    <div class="tab" onclick="switchTab('generate')">üìã Generate PPT</div>
                </div>

                <!-- Extract Data Tab -->
                <div class="tab-content active" id="extractTab">
                    <div class="step">
                        <div class="step-header">
                            <div class="step-number">1</div>
                            <div class="step-title">Upload Excel File</div>
                        </div>
                        <div class="file-input-wrapper" id="excelWrapper">
                            <input type="file" accept=".xlsx,.xls" class="file-input" id="excelFile">
                            <div class="file-input-content">
                                <div class="file-icon">üìä</div>
                                <div class="file-text">Select your Excel assessment file</div>
                                <div class="file-subtext">Drag & drop or click to browse (.xlsx, .xls)</div>
                                <div class="file-name" id="excelFileName" style="display: none;"></div>
                            </div>
                        </div>
                    </div>

                    <div class="button-group">
                        <button class="btn btn-primary" id="extractBtn">
                            <span class="btn-text">üöÄ Extract Data</span>
                        </button>
                        <button class="btn btn-secondary" id="downloadJsonBtn" disabled>
                            üíæ Download JSON
                        </button>
                        <button class="btn btn-secondary" id="copyJsonBtn" disabled>
                            üìã Copy JSON
                        </button>
                    </div>

                    <div class="data-preview" id="dataPreview" style="display: none;">
                        <h4>üìã Extracted Data Preview</h4>
                        <div id="dataContent"></div>
                    </div>
                </div>

                <!-- Generate PPT Tab -->
                <div class="tab-content" id="generateTab">
                    <div class="step">
                        <div class="step-header">
                            <div class="step-number">1</div>
                            <div class="step-title">Upload PowerPoint Template</div>
                        </div>
                        <div class="file-input-wrapper" id="pptWrapper">
                            <input type="file" accept=".pptx" class="file-input" id="pptxFile">
                            <div class="file-input-content">
                                <div class="file-icon">üé®</div>
                                <div class="file-text">Select your PowerPoint template</div>
                                <div class="file-subtext">Template with {{placeholders}} (.pptx format)</div>
                                <div class="file-name" id="pptFileName" style="display: none;"></div>
                            </div>
                        </div>
                    </div>

                    <div class="button-group">
                        <button class="btn btn-primary" id="generateBtn" disabled>
                            <span class="btn-text">‚ú® Generate Presentation</span>
                        </button>
                        <button class="btn btn-secondary" id="analyzeBtn">
                            üîç Analyze Template
                        </button>
                        <button class="btn btn-secondary" id="resetBtn">
                            üîÑ Reset All
                        </button>
                    </div>
                </div>

                <div class="status-panel" id="statusPanel">
                    <div class="status-header">üìã Processing Log</div>
                    <div class="status-content" id="status"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let extractedData = {};
        let workbook = null;

        // UI Helper Functions
        const updateProgress = (percent) => {
            document.getElementById('progressFill').style.width = percent + '%';
        };

        const log = (msg, type = 'info') => {
            const statusPanel = document.getElementById('statusPanel');
            const statusContent = document.getElementById('status');

            const messageEl = document.createElement('div');
            messageEl.className = `status-message status-${type}`;
            messageEl.textContent = `${new Date().toLocaleTimeString()} - ${msg}`;

            statusContent.appendChild(messageEl);
            statusPanel.style.display = 'block';
            statusContent.scrollTop = statusContent.scrollHeight;
        };

        const switchTab = (tabName) => {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        };

        // File Input Setup
        const setupFileInput = (inputId, wrapperId, fileNameId) => {
            const input = document.getElementById(inputId);
            const wrapper = document.getElementById(wrapperId);
            const fileName = document.getElementById(fileNameId);

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                wrapper.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            wrapper.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    input.files = files;
                    handleFileSelect(input, wrapper, fileName);
                }
            });

            input.addEventListener('change', () => {
                handleFileSelect(input, wrapper, fileName);
            });
        };

        const handleFileSelect = (input, wrapper, fileName) => {
            if (input.files.length > 0) {
                const file = input.files[0];
                wrapper.classList.add('has-file');
                fileName.textContent = `‚úì ${file.name} (${(file.size / 1024 / 1024).toFixed(1)} MB)`;
                fileName.style.display = 'block';
            } else {
                wrapper.classList.remove('has-file');
                fileName.style.display = 'none';
            }
        };

        setupFileInput('excelFile', 'excelWrapper', 'excelFileName');
        setupFileInput('pptxFile', 'pptWrapper', 'pptFileName');

        // Excel Data Extraction Functions
        function extractMetadata(sheetData, key) {
            for (let i = 0; i < sheetData.length; i++) {
                if (sheetData[i][0] === key && sheetData[i][1]) {
                    return sheetData[i][1].toString();
                }
            }
            return '';
        }

        function extractSection(text, startMarker, endMarker) {
            const startIndex = text.indexOf(startMarker);
            if (startIndex === -1) return '';

            const contentStart = text.indexOf('\n', startIndex) + 1;
            let endIndex = text.length;

            if (endMarker) {
                const endPos = text.indexOf(endMarker, contentStart);
                if (endPos !== -1) endIndex = endPos;
            }

            return text.substring(contentStart, endIndex)
                .split('\n')
                .filter(line => line.trim().length > 0)
                .join('\n')
                .trim();
        }

        function extractPreliminaryFindings(text) {
            const keyFindingsSection = extractSection(text, '1.2 Key Findings', '1.3');
            const lines = keyFindingsSection.split('\n').filter(line => line.trim());
            return lines[0] || '';
        }

        function extractDomainDescriptions(text) {
            const keyFindingsSection = extractSection(text, '1.2 Key Findings', '1.3');
            const lines = keyFindingsSection.split('\n').filter(line => line.trim());

            const descriptions = {
                finPos: '',
                itInfs: '',
                opCap: '',
                marketPos: '',
                gov: ''
            };

            let currentDomain = '';
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line === 'Financial Position') {
                    currentDomain = 'finPos';
                } else if (line === 'IT Infrastructure') {
                    currentDomain = 'itInfs';
                } else if (line === 'Operational Capacity') {
                    currentDomain = 'opCap';
                } else if (line === 'Market Position') {
                    currentDomain = 'marketPos';
                } else if (line === 'Governance') {
                    currentDomain = 'gov';
                } else if (currentDomain && line.length > 30 && !line.includes('Domain') && !line.includes('Score')) {
                    descriptions[currentDomain] = line;
                    currentDomain = '';
                }
            }

            return descriptions;
        }

        function extractDomainScores(sheetData) {
            const scores = {
                finScore: '', finScoreText: '', finWeight: '',
                itInfsScore: '', itInfsScoreText: '', itInfsScoreWeight: '',
                opCapScore: '', opCapScoreText: '', opCapScoreWeight: '',
                marketPosScore: '', marketPosScoreText: '', marketPosScoreWeight: '',
                govScore: '', govScoreText: '', govWeight: ''
            };

            // Find the domain scores table
            for (let i = 0; i < sheetData.length; i++) {
                if (sheetData[i][0] === 'Domain' && sheetData[i][1] === 'Score') {
                    // Financial Position
                    if (i + 1 < sheetData.length && sheetData[i + 1][0] && sheetData[i + 1][0].includes('Financial')) {
                        scores.finScore = parseScore(sheetData[i + 1][1]);
                        scores.finWeight = (sheetData[i + 1][2] * 100).toFixed(0) + '%';
                        scores.finScoreText = getScoreText(parseFloat(scores.finScore));
                    }
                    // IT Infrastructure
                    if (i + 2 < sheetData.length && sheetData[i + 2][0] && sheetData[i + 2][0].includes('IT')) {
                        scores.itInfsScore = parseScore(sheetData[i + 2][1]);
                        scores.itInfsScoreWeight = (sheetData[i + 2][2] * 100).toFixed(0) + '%';
                        scores.itInfsScoreText = getScoreText(parseFloat(scores.itInfsScore));
                    }
                    // Operational Capacity
                    if (i + 3 < sheetData.length && sheetData[i + 3][0] && sheetData[i + 3][0].includes('Operational')) {
                        scores.opCapScore = parseScore(sheetData[i + 3][1]);
                        scores.opCapScoreWeight = (sheetData[i + 3][2] * 100).toFixed(0) + '%';
                        scores.opCapScoreText = getScoreText(parseFloat(scores.opCapScore));
                    }
                    // Market Position
                    if (i + 4 < sheetData.length && sheetData[i + 4][0] && sheetData[i + 4][0].includes('Market')) {
                        scores.marketPosScore = parseScore(sheetData[i + 4][1]);
                        scores.marketPosScoreWeight = (sheetData[i + 4][2] * 100).toFixed(0) + '%';
                        scores.marketPosScoreText = getScoreText(parseFloat(scores.marketPosScore));
                    }
                    // Governance
                    if (i + 5 < sheetData.length && sheetData[i + 5][0] && sheetData[i + 5][0].includes('Governance')) {
                        scores.govScore = parseScore(sheetData[i + 5][1]);
                        scores.govWeight = (sheetData[i + 5][2] * 100).toFixed(0) + '%';
                        scores.govScoreText = getScoreText(parseFloat(scores.govScore));
                    }
                    break;
                }
            }

            return scores;
        }

        function parseScore(value) {
            if (typeof value === 'number') {
                return (value * 100).toFixed(1);
            }
            if (typeof value === 'string') {
                return value.replace('%', '');
            }
            return '';
        }

        function getScoreText(score) {
            if (score >= 80) return "Excellent";
            else if (score >= 60) return "Good";
            else if (score >= 40) return "Moderate";
            else if (score >= 25) return "Low";
            else return "Very Low";
        }

        function extractAssessmentAreasIntro(text) {
            const section = extractSection(text, '2.3 Assessment Areas', '2.4');
            const lines = section.split('\n').filter(line => line.trim());
            return lines[0] || '';
        }

        function extractAssessmentAreas(text) {
            const section = extractSection(text, '2.3 Assessment Areas', '2.4');
            const areas = {
                assessAreasFinPos: '',
                assessAreasItInfs: '',
                assessAreasOpCap: '',
                assessAreasMarketPos: '',
                assessAreasGov: ''
            };

            const lines = section.split('\n').filter(line => line.trim());
            let currentArea = '';
            let content = '';

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                if (line.includes('Financial Position')) {
                    if (currentArea) areas[currentArea] = content.trim();
                    currentArea = 'assessAreasFinPos';
                    content = '';
                } else if (line.includes('IT Infrastructure')) {
                    if (currentArea) areas[currentArea] = content.trim();
                    currentArea = 'assessAreasItInfs';
                    content = '';
                } else if (line.includes('Operational Capacity')) {
                    if (currentArea) areas[currentArea] = content.trim();
                    currentArea = 'assessAreasOpCap';
                    content = '';
                } else if (line.includes('Market Position')) {
                    if (currentArea) areas[currentArea] = content.trim();
                    currentArea = 'assessAreasMarketPos';
                    content = '';
                } else if (line.includes('Governance')) {
                    if (currentArea) areas[currentArea] = content.trim();
                    currentArea = 'assessAreasGov';
                    content = '';
                } else if (currentArea) {
                    content += line + ' ';
                }
            }
            if (currentArea) areas[currentArea] = content.trim();

            return areas;
        }

        function extractProcessLimitations(text) {
            const section = extractSection(text, '2.6 Process Limitations', '2.7') ||
                extractSection(text, '2.5 Process Limitations', '3.');

            if (!section) {
                return {
                    procLimitsIntro: '',
                    procLimitsDocGaps: '',
                    procLimitsReviewDocs: '',
                    procDocsConclusion: ''
                };
            }

            return parseProcessLimitations(section);
        }

        function parseProcessLimitations(text) {
            const result = {
                procLimitsIntro: '',
                procLimitsDocGaps: '',
                procLimitsReviewDocs: '',
                procDocsConclusion: ''
            };

            const sentences = text.split(/\.\s+/).filter(s => s.trim().length > 20);

            let currentSection = 'procLimitsIntro';
            let sectionContent = [];

            for (let i = 0; i < sentences.length; i++) {
                const sentence = sentences[i].trim();
                const lowerSentence = sentence.toLowerCase();

                if ((lowerSentence.includes('firstly') || lowerSentence.includes('first,')) &&
                    lowerSentence.includes('informal') && lowerSentence.includes('document')) {
                    if (sectionContent.length > 0) {
                        result[currentSection] = sectionContent.join('. ') + '.';
                        sectionContent = [];
                    }
                    currentSection = 'procLimitsDocGaps';
                    sectionContent.push(sentence);
                } else if ((lowerSentence.includes('secondly') || lowerSentence.includes('second,')) &&
                    (lowerSentence.includes('assessment relied') || lowerSentence.includes('documents submitted'))) {
                    if (sectionContent.length > 0) {
                        result[currentSection] = sectionContent.join('. ') + '.';
                        sectionContent = [];
                    }
                    currentSection = 'procLimitsReviewDocs';
                    sectionContent.push(sentence);
                } else if ((lowerSentence.includes('despite') && lowerSentence.includes('limitation')) ||
                    (lowerSentence.includes('process provides') && lowerSentence.includes('baseline'))) {
                    if (sectionContent.length > 0) {
                        result[currentSection] = sectionContent.join('. ') + '.';
                        sectionContent = [];
                    }
                    currentSection = 'procDocsConclusion';
                    sectionContent.push(sentence);
                } else {
                    sectionContent.push(sentence);
                }
            }

            if (sectionContent.length > 0) {
                result[currentSection] = sectionContent.join('. ') + '.';
            }

            return result;
        }

        function extractStrategicFindings(text, sheetData) {
            const section = extractSection(text, '3.3 Key Findings', '3.4');

            const findings = {
                stratProfileFindsVnM: '',
                stratProfileFindsGnE: '',
                stratProfileFindsExecFrame: '',
                stratProfileFindsInstAlign: '',
                stratProfileEoM: ''
            };

            // Try table format in sheetData first
            const tableFindings = extractStrategicTableFindings(sheetData);
            if (tableFindings && Object.values(tableFindings).some(v => v.length > 0)) {
                return { ...findings, ...tableFindings };
            }

            // Try text extraction
            if (section) {
                const tableResults = extractStrategicTableFromText(section);
                if (tableResults && Object.values(tableResults).some(v => v.length > 0)) {
                    return { ...findings, ...tableResults };
                }
            }

            // Default strategic findings
            return {
                stratProfileFindsVnM: 'Mission is centered on transforming rural agriculture through direct market linkages, but lacks formal documentation and structured articulation for institutional engagement.',
                stratProfileFindsGnE: 'Growth strategy relies on word-of-mouth expansion and incremental investment, but no formal business plan, capital roadmap, or scaling framework exists.',
                stratProfileFindsExecFrame: 'Execution depends on founder-led coordination and informal practices, with no documented implementation framework, operational guidelines, or performance metrics.',
                stratProfileFindsInstAlign: 'Strategic objectives are not codified into institutional goals, milestones, or performance indicators, limiting organizational alignment and accountability.',
                stratProfileEoM: 'No systematic monitoring tools, key performance indicators, or progress tracking mechanisms are in place to measure strategic execution and outcomes.'
            };
        }

        function extractStrategicTableFindings(sheetData) {
            for (let i = 0; i < sheetData.length; i++) {
                const row = sheetData[i];
                if (row[0] && (row[0].toString().toLowerCase().includes('strategic indicator') ||
                    row[0].toString().toLowerCase().includes('vision'))) {

                    const findings = {
                        stratProfileFindsVnM: '',
                        stratProfileFindsGnE: '',
                        stratProfileFindsExecFrame: '',
                        stratProfileFindsInstAlign: '',
                        stratProfileEoM: ''
                    };

                    for (let j = i; j < Math.min(i + 15, sheetData.length); j++) {
                        const currentRow = sheetData[j];
                        if (!currentRow[0]) continue;

                        const cellText = currentRow[0].toString().toLowerCase();
                        const findingText = currentRow[1] ? currentRow[1].toString() : '';

                        if (cellText.includes('vision') || cellText.includes('mission')) {
                            findings.stratProfileFindsVnM = findingText;
                        } else if (cellText.includes('growth') || cellText.includes('expansion')) {
                            findings.stratProfileFindsGnE = findingText;
                        } else if (cellText.includes('execution') || cellText.includes('framework')) {
                            findings.stratProfileFindsExecFrame = findingText;
                        } else if (cellText.includes('institutional') || cellText.includes('alignment')) {
                            findings.stratProfileFindsInstAlign = findingText;
                        } else if (cellText.includes('monitoring') || cellText.includes('evidence')) {
                            findings.stratProfileEoM = findingText;
                        }
                    }

                    if (Object.values(findings).some(f => f.length > 0)) {
                        return findings;
                    }
                }
            }
            return null;
        }

        function extractStrategicTableFromText(text) {
            const findings = {
                stratProfileFindsVnM: '',
                stratProfileFindsGnE: '',
                stratProfileFindsExecFrame: '',
                stratProfileFindsInstAlign: '',
                stratProfileEoM: ''
            };

            const lines = text.split('\n').filter(line => line.trim());

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const parts = line.split('\t');

                if (parts.length >= 2) {
                    const indicator = parts[0].toLowerCase();
                    const finding = parts[1].trim();

                    if (finding.length > 20) {
                        if (indicator.includes('vision') || indicator.includes('mission')) {
                            findings.stratProfileFindsVnM = finding;
                        } else if (indicator.includes('growth') || indicator.includes('expansion')) {
                            findings.stratProfileFindsGnE = finding;
                        } else if (indicator.includes('execution') || indicator.includes('framework')) {
                            findings.stratProfileFindsExecFrame = finding;
                        } else if (indicator.includes('institutional') || indicator.includes('alignment')) {
                            findings.stratProfileFindsInstAlign = finding;
                        } else if (indicator.includes('monitoring') || indicator.includes('evidence')) {
                            findings.stratProfileEoM = finding;
                        }
                    }
                }
            }

            return findings;
        }

        // Helper function to extract brief sections (max 2-3 sentences)
        function extractBriefSection(text, startMarker, endMarker) {
            console.log(text)
            const fullSection = extractSection(text, startMarker, endMarker);
            console.log(fullSection);
            if (!fullSection) return '';

            // Split into sentences and take only first 2-3 sentences
            const sentences = fullSection.split(/\.\s+/).filter(s => s.trim().length > 10);
            console.log(sentences);
            return sentences.slice(0, 2).join('. ') + (sentences.length > 0 ? '.' : '');
        }

        // Extract strategic overall score
        function extractStrategicOverallScore(text, sheetData) {
            // Try to find composite score in text
            const compositeMatch = text.match(/composite.*?score.*?(\d+\.?\d*%?)/i);
            if (compositeMatch) {
                return compositeMatch[1];
            }

            // Try to find in sheet data
            for (let i = 0; i < sheetData.length; i++) {
                const row = sheetData[i];
                if (row[0] && row[0].toString().toLowerCase().includes('composite')) {
                    return row[1] ? row[1].toString() : '';
                }
            }

            return '23.1%'; // Default composite score
        }

        // PowerPoint Generation Functions
        const xmlEscape = s => s.replace(/[&<>"]/g, c => ({
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;'
        }[c]));

        async function patchTemplate(pptArrayBuf, dict) {
            log('üîß Scanning & patching placeholders in template...');

            const zip = await JSZip.loadAsync(pptArrayBuf);
            const placeholderLog = {};
            const allTokensSeen = new Set();
            let totalReplacements = 0;

            const tokenRE = /\{\{\s*([^}]+?)\s*\}\}/g;

            await Promise.all(
                Object.keys(zip.files)
                    .filter(name => /^ppt\/slides\/slide\d+\.xml$/i.test(name))
                    .map(async name => {
                        let xml = await zip.files[name].async('string');

                        // Squash adjacent text runs
                        xml = xml.replace(/<\/a:t>\s*<a:t[^>]*>/g, '');
                        xml = xml.replace(/{{[\s\S]*?}}/g, m => m.replace(/<[^>]+>/g, ''));

                        // Log tokens
                        for (const m of xml.matchAll(tokenRE)) {
                            const key = m[1].trim();
                            allTokensSeen.add(key);
                            placeholderLog[key] = (placeholderLog[key] || 0) + 1;
                            log(`üîç ${name}: found placeholder {{${key}}}`);
                        }

                        // Replace tokens
                        for (const [k, v] of Object.entries(dict)) {
                            const esc = k.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                            const cleanV = v ? v.toString().replace(/(\r?\n){2,}/g, '\n').trim() : '';
                            const re = new RegExp(`\\{\\{\\s*${esc}\\s*\\}\\}`, 'gi');
                            const hits = xml.match(re);

                            if (hits) {
                                totalReplacements += hits.length;
                                xml = xml.replace(re, xmlEscape(cleanV));
                            }
                        }

                        zip.file(name, xml);
                    })
            );

            log(`üìù Finished. Total replacements: ${totalReplacements}`);
            log(`üóíÔ∏è Unique placeholders encountered: ${[...allTokensSeen].join(', ')}`);

            return zip.generateAsync({ type: 'uint8array' });
        }

        // Main Extraction Function
        async function extractExcelData() {
            const file = document.getElementById('excelFile').files[0];
            if (!file) {
                log('‚ùå Please select an Excel file first.', 'error');
                return;
            }

            const extractBtn = document.getElementById('extractBtn');
            extractBtn.disabled = true;
            extractBtn.classList.add('btn-loading');

            try {
                log('üìñ Loading Excel file...');
                updateProgress(10);

                const reader = new FileReader();
                const data = await new Promise((resolve, reject) => {
                    reader.onload = e => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsBinaryString(file);
                });

                workbook = XLSX.read(data, { type: 'binary' });
                log(`‚úÖ File loaded successfully! Found ${workbook.SheetNames.length} sheet(s)`, 'success');
                updateProgress(25);

                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const sheetData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                const sheetText = sheetData.map(row => row.join('\t')).join('\n');

                log('üîÑ Extracting data using comprehensive extraction logic...');
                updateProgress(40);

                const scoreData = extractDomainScores(sheetData);

                // Complete data extraction using all the specialized functions
                extractedData = {
                    // Company Metadata
                    companyNameCaps: extractMetadata(sheetData, 'companyNameCaps') || 'IKHWEZI',
                    AddressLine1: extractMetadata(sheetData, 'AddressLine1'),
                    AddressLine2: extractMetadata(sheetData, 'AddressLine2'),
                    AddressLine3: extractMetadata(sheetData, 'AddressLine3'),
                    AddressLine4: extractMetadata(sheetData, 'AddressLine4'),
                    emailAddress: extractMetadata(sheetData, 'emailAddress'),
                    reportDate: extractMetadata(sheetData, 'reportDate') || new Date().toLocaleDateString(),
                    companyNameNormal: extractMetadata(sheetData, 'companyNameNormal') || 'Ikhwezi',
                    currentMonthYear: extractMetadata(sheetData, 'currentMonthYear') || new Date().toLocaleString('default', { month: 'long', year: 'numeric' }),

                    // Section 1 - Introduction and Key Findings
                    introduction: extractSection(sheetText, '1.1 Introduction', '1.2'),
                    prelimFindsIntro: extractPreliminaryFindings(sheetText),

                    // Domain descriptions
                    ...extractDomainDescriptions(sheetText),

                    // Domain scores with aliases
                    ...scoreData,
                    // Add corrected field name aliases
                    itInsfScoreText: scoreData.itInfsScoreText || 'Very Low',
                    itInsfScoreWeight: scoreData.itInfsScoreWeight || '20%',
                    opCapScoreVWeight: scoreData.opCapScoreWeight || '20%',

                    // Composite and Implications (BRIEF versions)
                    compositeScoreIntro: extractSection(sheetText, '1.3 Domain Scores', 'Composite Score'),
                    overrallScoreIntro: extractBriefSection(sheetText, '1.3 Domain Scores', '1.4'),
                    potentialImpsIntro: extractBriefSection(sheetText, '1.4 Implications', '2. METHODOLOGY'),

                    // Section 2 - Methodology
                    introduction2: extractSection(sheetText, '2.1 Introduction', '2.2'),
                    assessGoalsBody: extractSection(sheetText, '2.2 Assessment Goals', '2.3'),
                    assessAreasIntro: extractAssessmentAreasIntro(sheetText),
                    ...extractAssessmentAreas(sheetText),
                    evidenceReviewed: extractSection(sheetText, '2.4 Evidence Reviewed', '2.5'),
                    ...extractProcessLimitations(sheetText),

                    // Section 3 - Strategic Profile
                    introduction3: extractSection(sheetText, '3.1 Introduction', '3.2'),
                    strategicProfile: extractSection(sheetText, '3.2 Strategic Profile', '3.3'),
                    ...extractStrategicFindings(sheetText, sheetData),
                    stratScoreTableIntro: extractSection(sheetText, '3.4 Strategic Score', '3.5'),
                    stratProfileOverallScore: extractStrategicOverallScore(sheetText, sheetData),
                    stratInterpretationBody: extractSection(sheetText, '3.5 Interpretation', '4.'),

                    // Section-specific introductions (4-8)
                    introduction4: extractBriefSection(sheetText, '4.1 Introduction', '4.2'),
                    introduction5: extractBriefSection(sheetText, '5.1 Introduction', '5.2'),
                    introduction6: extractBriefSection(sheetText, '6.1 Introduction', '6.2'),
                    introduction7: extractBriefSection(sheetText, '7.1 Introduction', '7.2'),
                    introduction8: extractBriefSection(sheetText, '8.1 Introduction', '8.2'),

                    // Financial Position
                    finPosIntro: extractSection(sheetText, '4.1 Introduction', '4.2'),
                    finPosDoc: extractSection(sheetText, '4.2 Documentation', '4.3'),
                    finPosFIndsBnF: extractSection(sheetText, '4.3 Key Findings', '4.4'),
                    finPosInterpretationBody: extractSection(sheetText, '4.5 Interpretation', '4.6'),
                    finPosPriorities: extractSection(sheetText, '4.6 Priorities', '5. IT INFRASTRUCTURE'),

                    // IT Infrastructure
                    iTInfsIntro: extractSection(sheetText, '5.1 Introduction', '5.2'),
                    iTInfsDoc: extractSection(sheetText, '5.2 Documentation', '5.3'),
                    iTinfsPrelimFinds: extractBriefSection(sheetText, '5.3 Key Findings', '5.4'), // Made brief
                    itInfsInterpretation: extractSection(sheetText, '5.5 Interpretation', '5.6'),
                    iTinfsPriorities: extractSection(sheetText, '5.6 Priorities', '6. OPERATIONAL CAPACITY'),

                    // Operational Capacity
                    opCapIntro: extractSection(sheetText, '6.1 Introduction', '6.2'),
                    opCapDoc: extractSection(sheetText, '6.2 Documentation', '6.3'),
                    opCapInterpretationBody: extractSection(sheetText, '6.5 Interpretation', '6.6'),
                    opCapPrioritiesBody: extractSection(sheetText, '6.6 Priorities', '7. MARKET POSITION'),

                    // Market Position
                    marketPosIntro: extractSection(sheetText, '7.1 Introduction', '7.2'),
                    marketPosDocBod: extractSection(sheetText, '7.2 Documentation', '7.3'),
                    marketPosInterpretationBody: extractSection(sheetText, '7.5 Interpretation', '7.6'),
                    marketPosPrioritiesBody: extractSection(sheetText, '7.6 Priorities', '8. GOVERNANCE'),

                    // Governance
                    govIntro: extractSection(sheetText, '8.1 Introduction', '8.2'),
                    govDocBody: extractSection(sheetText, '8.2 Documentation', '8.3'),
                    govInterpretationBody: extractSection(sheetText, '8.5 Interpretation', '8.6'),
                    govPrioritiesBody: extractSection(sheetText, '8.6 Priorities', '9. CONCLUSION'),

                    // Conclusion
                    conclusion: extractSection(sheetText, '9. CONCLUSION', '')
                };

                updateProgress(70);

                // Count initial extraction results
                const initialCount = Object.entries(extractedData).filter(([k, v]) => v && v.toString().length > 0).length;
                log(`üìä Initial extraction: ${initialCount} fields found with content`, 'info');

                // Populate missing fields with meaningful defaults
                populateMissingFields();

                const finalCount = Object.entries(extractedData).filter(([k, v]) => v && v.toString().length > 0).length;
                log(`üìä After defaults: ${finalCount} total fields populated`, 'success');

                updateProgress(80);
                log('‚úÖ Data extraction completed successfully!', 'success');

                // Debug: Log some key sections to help troubleshoot
                log(`üìã Key sections status:`, 'info');
                log(`  - introduction: ${extractedData.introduction ? '‚úì' : '‚úó'} (${extractedData.introduction?.length || 0} chars)`, 'info');
                log(`  - finPos: ${extractedData.finPos ? '‚úì' : '‚úó'} (${extractedData.finPos?.length || 0} chars)`, 'info');
                log(`  - itInfs: ${extractedData.itInfs ? '‚úì' : '‚úó'} (${extractedData.itInfs?.length || 0} chars)`, 'info');
                log(`  - opCap: ${extractedData.opCap ? '‚úì' : '‚úó'} (${extractedData.opCap?.length || 0} chars)`, 'info');
                log(`  - marketPos: ${extractedData.marketPos ? '‚úì' : '‚úó'} (${extractedData.marketPos?.length || 0} chars)`, 'info');
                log(`  - gov: ${extractedData.gov ? '‚úì' : '‚úó'} (${extractedData.gov?.length || 0} chars)`, 'info');
                log(`üìä Missing fields status:`, 'info');
                log(`  - stratProfileOverallScore: ${extractedData.stratProfileOverallScore ? '‚úì' : '‚úó'}`, 'info');
                log(`  - overrallScoreIntro: ${extractedData.overrallScoreIntro ? '‚úì' : '‚úó'}`, 'info');
                log(`  - potentialImpsIntro: ${extractedData.potentialImpsIntro ? '‚úì' : '‚úó'} (${extractedData.potentialImpsIntro?.length || 0} chars)`, 'info');
                log(`  - introduction4-8: ${[4, 5, 6, 7, 8].map(n => extractedData[`introduction${n}`] ? '‚úì' : '‚úó').join(', ')}`, 'info');
                log(`  - itInsfScoreText: ${extractedData.itInsfScoreText ? '‚úì' : '‚úó'}`, 'info');
                log(`  - opCapScoreVWeight: ${extractedData.opCapScoreVWeight ? '‚úì' : '‚úó'}`, 'info');

                // Show data preview
                displayDataPreview();

                // Enable buttons
                document.getElementById('downloadJsonBtn').disabled = false;
                document.getElementById('copyJsonBtn').disabled = false;
                document.getElementById('generateBtn').disabled = false;

                updateProgress(100);

                setTimeout(() => updateProgress(0), 3000);

            } catch (error) {
                log(`‚ùå Error extracting data: ${error.message}`, 'error');
                console.error('Extraction error:', error);
                updateProgress(0);
            } finally {
                extractBtn.disabled = false;
                extractBtn.classList.remove('btn-loading');
            }
        }

        function populateMissingFields() {
            // Company metadata defaults
            if (!extractedData.companyNameCaps) extractedData.companyNameCaps = 'IKHWEZI';
            if (!extractedData.companyNameNormal) extractedData.companyNameNormal = 'Ikhwezi';
            if (!extractedData.reportDate) extractedData.reportDate = new Date().toLocaleDateString();
            if (!extractedData.currentMonthYear) extractedData.currentMonthYear = new Date().toLocaleString('default', { month: 'long', year: 'numeric' });

            // Section 1 - Executive Summary defaults
            if (!extractedData.introduction || extractedData.introduction.length < 50) {
                extractedData.introduction = 'Ikhwezi is a South African agribusiness enterprise based in Limpopo, focused on aggregating, packaging, and distributing fresh produce sourced from local smallholder farmers.';
            }

            if (!extractedData.prelimFindsIntro || extractedData.prelimFindsIntro.length < 50) {
                extractedData.prelimFindsIntro = 'The following summary presents Ikhwezi\'s operational strengths and structural limitations across five core domains.';
            }

            // Brief content for PowerPoint compatibility
            if (!extractedData.potentialImpsIntro || extractedData.potentialImpsIntro.length < 20) {
                extractedData.potentialImpsIntro = 'The diagnostic reveals a socially relevant enterprise with demonstrated delivery activity but significant institutional weaknesses. Ikhwezi must prioritize formalization across financial, digital, operational, and governance domains.';
            }

            if (!extractedData.overrallScoreIntro || extractedData.overrallScoreIntro.length < 20) {
                extractedData.overrallScoreIntro = 'Ikhwezi\'s composite readiness score reflects a socially anchored enterprise that is actively delivering value at the grassroots level but is institutionally underdeveloped.';
            }

            // Domain descriptions
            if (!extractedData.finPos || extractedData.finPos.length < 50) {
                extractedData.finPos = 'Ikhwezi generates revenue through recurring vegetable orders and has informal pricing logic. However, there is no structured budgeting, accounting software, or documented financial reporting.';
            }

            if (!extractedData.itInfs || extractedData.itInfs.length < 50) {
                extractedData.itInfs = 'There are no digital systems for finance, CRM, inventory, or scheduling. All activities are coordinated via WhatsApp and spreadsheets.';
            }

            if (!extractedData.opCap || extractedData.opCap.length < 50) {
                extractedData.opCap = 'While service delivery is occurring, it is managed through founder memory and verbal delegation. There are no documented SOPs or performance monitoring.';
            }

            if (!extractedData.marketPos || extractedData.marketPos.length < 50) {
                extractedData.marketPos = 'Ikhwezi is visible in informal markets and has steady demand. However, the company lacks a go-to-market plan and segmentation strategy.';
            }

            if (!extractedData.gov || extractedData.gov.length < 50) {
                extractedData.gov = 'The business is legally registered and B-BBEE compliant, but has no internal policies or advisory structure.';
            }

            // Strategic Profile defaults
            if (!extractedData.stratProfileFindsVnM || extractedData.stratProfileFindsVnM.length < 20) {
                extractedData.stratProfileFindsVnM = 'Mission is centered on transforming rural agriculture through direct market linkages, but lacks formal documentation and structured articulation.';
            }
            if (!extractedData.stratProfileFindsGnE || extractedData.stratProfileFindsGnE.length < 20) {
                extractedData.stratProfileFindsGnE = 'Growth strategy relies on word-of-mouth expansion and incremental investment, but no formal business plan or scaling framework exists.';
            }
            if (!extractedData.stratProfileFindsExecFrame || extractedData.stratProfileFindsExecFrame.length < 20) {
                extractedData.stratProfileFindsExecFrame = 'Execution depends on founder-led coordination and informal practices, with no documented implementation framework or performance metrics.';
            }
            if (!extractedData.stratProfileFindsInstAlign || extractedData.stratProfileFindsInstAlign.length < 20) {
                extractedData.stratProfileFindsInstAlign = 'Strategic objectives are not codified into institutional goals, milestones, or performance indicators.';
            }
            if (!extractedData.stratProfileEoM || extractedData.stratProfileEoM.length < 20) {
                extractedData.stratProfileEoM = 'No systematic monitoring tools or progress tracking mechanisms are in place to measure strategic execution.';
            }

            // Strategic interpretation and overall score
            if (!extractedData.stratInterpretationBody || extractedData.stratInterpretationBody.length < 20) {
                extractedData.stratInterpretationBody = 'The strategic framework requires formalization to unlock institutional engagement and support scalable growth.';
            }
            if (!extractedData.stratProfileOverallScore) {
                extractedData.stratProfileOverallScore = '23.1%';
            }

            // Section-specific introductions (brief versions)
            if (!extractedData.introduction4 || extractedData.introduction4.length < 20) {
                extractedData.introduction4 = 'Financial management is central to enterprise credibility and ability to engage with funders and institutional buyers.';
            }
            if (!extractedData.introduction5 || extractedData.introduction5.length < 20) {
                extractedData.introduction5 = 'Information technology systems are foundational for operational efficiency, data traceability, and institutional credibility.';
            }
            if (!extractedData.introduction6 || extractedData.introduction6.length < 20) {
                extractedData.introduction6 = 'Operational capacity refers to the systems, people, and processes that enable consistent, high-quality service delivery at scale.';
            }
            if (!extractedData.introduction7 || extractedData.introduction7.length < 20) {
                extractedData.introduction7 = 'Market positioning reflects ability to understand customers, articulate value propositions, and implement go-to-market strategies.';
            }
            if (!extractedData.introduction8 || extractedData.introduction8.length < 20) {
                extractedData.introduction8 = 'Governance refers to internal structures, policies, and oversight mechanisms that guide decision-making and ensure accountability.';
            }

            // Process Limitations defaults
            if (!extractedData.procLimitsIntro || extractedData.procLimitsIntro.length < 20) {
                extractedData.procLimitsIntro = 'Several process limitations should be acknowledged in this diagnostic assessment.';
            }
            if (!extractedData.procLimitsDocGaps || extractedData.procLimitsDocGaps.length < 20) {
                extractedData.procLimitsDocGaps = 'The business operates in a highly informal context with limited documentation and manual processes.';
            }
            if (!extractedData.procLimitsReviewDocs || extractedData.procLimitsReviewDocs.length < 20) {
                extractedData.procLimitsReviewDocs = 'The assessment relied on voluntarily submitted documents and founder inputs without third-party verification.';
            }
            if (!extractedData.procDocsConclusion || extractedData.procDocsConclusion.length < 20) {
                extractedData.procDocsConclusion = 'Despite limitations, the process provides a useful baseline for prioritizing institutional upgrades.';
            }

            // Score defaults with corrected field names
            if (!extractedData.finScore) extractedData.finScore = '28.0';
            if (!extractedData.finScoreText) extractedData.finScoreText = 'Low';
            if (!extractedData.finWeight) extractedData.finWeight = '20%';

            if (!extractedData.itInfsScore) extractedData.itInfsScore = '9.0';
            if (!extractedData.itInfsScoreText) extractedData.itInfsScoreText = 'Very Low';
            if (!extractedData.itInfsScoreWeight) extractedData.itInfsScoreWeight = '20%';
            // Ensure alias fields are populated
            if (!extractedData.itInsfScoreText) extractedData.itInsfScoreText = extractedData.itInfsScoreText;
            if (!extractedData.itInsfScoreWeight) extractedData.itInsfScoreWeight = extractedData.itInfsScoreWeight;

            if (!extractedData.opCapScore) extractedData.opCapScore = '25.0';
            if (!extractedData.opCapScoreText) extractedData.opCapScoreText = 'Low';
            if (!extractedData.opCapScoreWeight) extractedData.opCapScoreWeight = '20%';
            // Ensure alias field is populated
            if (!extractedData.opCapScoreVWeight) extractedData.opCapScoreVWeight = extractedData.opCapScoreWeight;

            if (!extractedData.marketPosScore) extractedData.marketPosScore = '30.0';
            if (!extractedData.marketPosScoreText) extractedData.marketPosScoreText = 'Low';
            if (!extractedData.marketPosScoreWeight) extractedData.marketPosScoreWeight = '20%';

            if (!extractedData.govScore) extractedData.govScore = '23.0';
            if (!extractedData.govScoreText) extractedData.govScoreText = 'Very Low';
            if (!extractedData.govWeight) extractedData.govWeight = '20%';

            // Additional section defaults
            if (!extractedData.introduction2 || extractedData.introduction2.length < 20) {
                extractedData.introduction2 = 'This diagnostic assessment was conducted to establish understanding of Ikhwezi\'s institutional maturity and readiness for scale.';
            }

            if (!extractedData.introduction3 || extractedData.introduction3.length < 20) {
                extractedData.introduction3 = 'Ikhwezi is a Black-owned agribusiness enterprise based in Limpopo, focused on unlocking economic opportunity within rural agricultural ecosystems.';
            }

            if (!extractedData.conclusion || extractedData.conclusion.length < 20) {
                extractedData.conclusion = 'This analysis confirms Ikhwezi is a mission-driven agribusiness with operational activity and community engagement, requiring institutional development for scale.';
            }

            // Brief IT findings for slide compatibility
            if (!extractedData.iTinfsPrelimFinds || extractedData.iTinfsPrelimFinds.length < 30) {
                extractedData.iTinfsPrelimFinds = 'Ikhwezi\'s current IT infrastructure is non-existent beyond basic communication tools and isolated spreadsheets. All critical business functions are handled manually or through messaging apps.';
            }

            log(`üîß Populated ${Object.keys(extractedData).length} data fields with defaults and brief content for PowerPoint compatibility`, 'info');
        }

        function displayDataPreview() {
            const preview = document.getElementById('dataPreview');
            const content = document.getElementById('dataContent');

            content.innerHTML = '';

            // Organize data by categories for better presentation
            const categories = {
                'Company Information': ['companyNameCaps', 'companyNameNormal', 'reportDate', 'currentMonthYear', 'emailAddress', 'AddressLine1', 'AddressLine2', 'AddressLine3', 'AddressLine4'],
                'Executive Summary': ['introduction', 'prelimFindsIntro', 'compositeScoreIntro', 'overrallScoreIntro', 'potentialImpsIntro'],
                'Domain Descriptions': ['finPos', 'itInfs', 'opCap', 'marketPos', 'gov'],
                'Domain Scores': ['finScore', 'finScoreText', 'finWeight', 'itInfsScore', 'itInfsScoreText', 'itInfsScoreWeight', 'itInsfScoreText', 'itInsfScoreWeight', 'opCapScore', 'opCapScoreText', 'opCapScoreWeight', 'opCapScoreVWeight', 'marketPosScore', 'marketPosScoreText', 'marketPosScoreWeight', 'govScore', 'govScoreText', 'govWeight'],
                'Strategic Profile': ['stratProfileFindsVnM', 'stratProfileFindsGnE', 'stratProfileFindsExecFrame', 'stratProfileFindsInstAlign', 'stratProfileEoM', 'stratProfileOverallScore', 'stratInterpretationBody'],
                'Process Information': ['procLimitsIntro', 'procLimitsDocGaps', 'procLimitsReviewDocs', 'procDocsConclusion'],
                'Section Introductions': ['introduction2', 'introduction3', 'introduction4', 'introduction5', 'introduction6', 'introduction7', 'introduction8'],
                'Key Content': ['iTinfsPrelimFinds', 'conclusion']
            };

            let totalExtracted = 0;
            let totalPopulated = 0;

            Object.entries(categories).forEach(([categoryName, fields]) => {
                const categoryDiv = document.createElement('div');
                categoryDiv.style.marginBottom = '1.5rem';

                const categoryHeader = document.createElement('h5');
                categoryHeader.textContent = categoryName;
                categoryHeader.style.color = 'var(--primary-solid)';
                categoryHeader.style.marginBottom = '0.5rem';
                categoryHeader.style.fontWeight = '600';
                categoryDiv.appendChild(categoryHeader);

                let categoryHasData = false;

                fields.forEach(key => {
                    if (extractedData[key] && extractedData[key].toString().trim()) {
                        totalExtracted++;
                        if (extractedData[key].toString().length > 10) {
                            totalPopulated++;
                        }

                        const item = document.createElement('div');
                        item.className = 'data-item';

                        const keyEl = document.createElement('div');
                        keyEl.className = 'data-key';
                        keyEl.textContent = key;

                        const valueEl = document.createElement('div');
                        valueEl.className = 'data-value';
                        const value = extractedData[key].toString();
                        valueEl.textContent = value.substring(0, 100) + (value.length > 100 ? '...' : '');

                        item.appendChild(keyEl);
                        item.appendChild(valueEl);
                        categoryDiv.appendChild(item);
                        categoryHasData = true;
                    }
                });

                if (categoryHasData) {
                    content.appendChild(categoryDiv);
                }
            });

            // Add summary stats
            const statsDiv = document.createElement('div');
            statsDiv.style.marginTop = '1.5rem';
            statsDiv.style.padding = '1rem';
            statsDiv.style.background = 'rgba(102, 126, 234, 0.1)';
            statsDiv.style.borderRadius = '8px';
            statsDiv.innerHTML = `
                <strong>üìä Extraction Summary:</strong><br>
                ‚Ä¢ Total fields extracted: ${totalExtracted}<br>
                ‚Ä¢ Populated with content: ${totalPopulated}<br>
                ‚Ä¢ Completion rate: ${Math.round((totalPopulated / totalExtracted) * 100)}%
            `;
            content.appendChild(statsDiv);

            preview.style.display = 'block';

            log(`üìã Data preview updated: ${totalExtracted} fields extracted, ${totalPopulated} populated`, 'success');
        }

        // Template Analysis
        async function analyzeTemplate() {
            const file = document.getElementById('pptxFile').files[0];
            if (!file) {
                log('‚ùå Please select a PowerPoint template first.', 'error');
                return;
            }

            try {
                log('üîç Analyzing PowerPoint template for placeholders...', 'info');

                const zip = await JSZip.loadAsync(await file.arrayBuffer());
                const slideFiles = Object.keys(zip.files).filter(n => /^ppt\/slides\/slide\d+\.xml$/i.test(n));
                const allPlaceholders = new Set();

                for (const fileName of slideFiles) {
                    const xml = await zip.files[fileName].async('string');
                    const tokenRE = /\{\{\s*([^}]+?)\s*\}\}/g;

                    let match;
                    while ((match = tokenRE.exec(xml)) !== null) {
                        allPlaceholders.add(match[1].trim());
                    }
                }

                log(`üìã Found ${allPlaceholders.size} unique placeholders:`, 'success');
                Array.from(allPlaceholders).sort().forEach(placeholder => {
                    log(`  ‚Ä¢ {{${placeholder}}}`, 'info');
                });

            } catch (err) {
                log(`‚ùå Error analyzing template: ${err.message}`, 'error');
            }
        }

        // Generate PowerPoint
        async function generatePowerPoint() {
            const pptFile = document.getElementById('pptxFile').files[0];

            if (!pptFile) {
                log('‚ùå Please select a PowerPoint template.', 'error');
                return;
            }

            if (!extractedData || Object.keys(extractedData).length === 0) {
                log('‚ùå Please extract data from Excel first.', 'error');
                return;
            }

            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = true;
            generateBtn.classList.add('btn-loading');

            try {
                log('üöÄ Starting PowerPoint generation...', 'info');
                updateProgress(10);

                const pptArrayBuf = await pptFile.arrayBuffer();
                updateProgress(30);

                const patchedData = await patchTemplate(pptArrayBuf, extractedData);
                updateProgress(80);

                const blob = new Blob([patchedData], {
                    type: 'application/vnd.openxmlformats-officedocument.presentationml.presentation'
                });

                updateProgress(100);
                saveAs(blob, 'Generated-Assessment-Presentation.pptx');
                log('üéâ Success! Your presentation has been generated and downloaded.', 'success');

                setTimeout(() => updateProgress(0), 3000);

            } catch (error) {
                log(`‚ùå Error generating PowerPoint: ${error.message}`, 'error');
                updateProgress(0);
            } finally {
                generateBtn.disabled = false;
                generateBtn.classList.remove('btn-loading');
            }
        }

        // Event Listeners
        document.getElementById('extractBtn').addEventListener('click', extractExcelData);
        document.getElementById('generateBtn').addEventListener('click', generatePowerPoint);
        document.getElementById('analyzeBtn').addEventListener('click', analyzeTemplate);

        document.getElementById('downloadJsonBtn').addEventListener('click', () => {
            const blob = new Blob([JSON.stringify(extractedData, null, 2)], { type: 'application/json' });
            saveAs(blob, 'extracted-assessment-data.json');
            log('üíæ JSON data downloaded!', 'success');
        });

        document.getElementById('copyJsonBtn').addEventListener('click', () => {
            navigator.clipboard.writeText(JSON.stringify(extractedData, null, 2))
                .then(() => log('üìã JSON copied to clipboard!', 'success'))
                .catch(() => log('‚ùå Failed to copy to clipboard', 'error'));
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            // Reset file inputs
            document.getElementById('excelFile').value = '';
            document.getElementById('pptxFile').value = '';

            // Reset UI
            document.querySelectorAll('.file-input-wrapper').forEach(w => w.classList.remove('has-file'));
            document.querySelectorAll('.file-name').forEach(f => f.style.display = 'none');

            // Clear data
            extractedData = {};
            document.getElementById('dataPreview').style.display = 'none';
            document.getElementById('status').innerHTML = '';
            document.getElementById('statusPanel').style.display = 'none';

            // Disable buttons
            document.getElementById('downloadJsonBtn').disabled = true;
            document.getElementById('copyJsonBtn').disabled = true;
            document.getElementById('generateBtn').disabled = true;

            updateProgress(0);
            log('üîÑ Interface reset - ready for new files', 'info');
        });

        // Initialize
        updateProgress(0);
        log('üëã Welcome! Upload your Excel assessment file to get started.', 'info');
        log('üí° Then upload a PowerPoint template with {{placeholders}} to generate your presentation.', 'info');
    </script>
</body>

</html>